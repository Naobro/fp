import streamlit as st
import pandas as pd

st.title("ğŸ  å®¶è³ƒè£œåŠ©ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")

# -------------------------
# å…¥åŠ›æ¬„
# -------------------------
age_start = st.number_input("ç¾åœ¨ã®å¹´é½¢", 20, 80, 35)
age_end = 90
support_end_age = st.number_input("å®¶è³ƒè£œåŠ©ãŒçµ‚äº†ã™ã‚‹å¹´é½¢", 40, 70, 65)

st.markdown("### å®¶è³ƒè¨­å®šï¼ˆæœ€å¤§6åŒºåˆ†ï¼‰")
rent_settings = []
for i in range(6):
    c1, c2, c3 = st.columns(3)
    with c1:
        start = st.number_input(f"åŒºåˆ†{i+1} é–‹å§‹å¹´é½¢", 20, 100, 30 + i * 10, key=f"start_{i}")
    with c2:
        end = st.number_input(f"åŒºåˆ†{i+1} çµ‚äº†å¹´é½¢", 20, 100, 39 + i * 10, key=f"end_{i}")
    with c3:
        rent = st.number_input(f"åŒºåˆ†{i+1} å®¶è³ƒ (ä¸‡å††)", 0, 100, 10 + i * 2, key=f"rent_{i}")
    rent_settings.append((start, end, rent))

st.markdown("### å®¶è³ƒè£œåŠ©ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªï¼ˆæ¯æœˆãƒ»ä¸‡å††ï¼‰")
c1, c2, c3 = st.columns(3)
with c1:
    waste = st.number_input("æµªè²» (ä¸‡å††)", 0, 50, 2)
with c2:
    save = st.number_input("è²¯è“„ (ä¸‡å††)", 0, 50, 2)
with c3:
    invest = st.number_input("é‹ç”¨ (ä¸‡å††)", 0, 50, 6)

rate = st.number_input("é‹ç”¨åˆ©å›ã‚Šï¼ˆå¹´%ï¼‰", 0.0, 10.0, 5.0) / 100

# -------------------------
# æ±äº¬ã‚¨ãƒªã‚¢åˆ¥å®¶è³ƒç›¸å ´è¡¨
# -------------------------
st.markdown("### ğŸ“Š æ±äº¬ã‚¨ãƒªã‚¢åˆ¥ å®¶è³ƒç›¸å ´ï¼ˆå‚è€ƒï¼‰")
rent_data = [
    ["éƒ½å¿ƒ5åŒº", "åƒä»£ç”°åŒºãƒ»ä¸­å¤®åŒºãƒ»æ¸¯åŒºãƒ»æ–°å®¿åŒºãƒ»æ¸‹è°·åŒº", "ç´„18ï½25ä¸‡å††", "ç´„28ï½35ä¸‡å††", "ç´„50ä¸‡å††å‰å¾Œ"],
    ["åŸå—åœ°åŒº", "å“å·åŒºãƒ»ç›®é»’åŒºãƒ»ä¸–ç”°è°·åŒºãƒ»å¤§ç”°åŒºãƒ»æ¸‹è°·åŒº", "ç´„16ã€œ20ä¸‡å††", "ç´„22ã€œ26ä¸‡å††", "ç´„25ã€œ32ä¸‡å††"],
    ["åŸåŒ—åœ°åŒº", "æ–‡äº¬åŒºãƒ»åŒ—åŒºãƒ»è’å·åŒºãƒ»æ¿æ©‹åŒºãƒ»è¶³ç«‹åŒºãƒ»è‘›é£¾åŒº", "ç´„9ã€œ13ä¸‡å††", "ç´„11ã€œ15ä¸‡å††", "ç´„16ã€œ20ä¸‡å††"],
    ["åŸè¥¿åœ°åŒº", "æ‰ä¸¦åŒºãƒ»ä¸­é‡åŒºãƒ»ç·´é¦¬åŒºãƒ»æ­¦è”µé‡å¸‚ãƒ»è¥¿æ±äº¬å¸‚", "ç´„12ã€œ16ä¸‡å††", "ç´„14ã€œ18ä¸‡å††", "ç´„17ã€œ22ä¸‡å††"],
    ["åŸæ±åœ°åŒº", "æ±Ÿæ±åŒºãƒ»å¢¨ç”°åŒºãƒ»æ±Ÿæˆ¸å·åŒºãƒ»å°æ±åŒºãƒ»è’å·åŒº", "ç´„13ã€œ16ä¸‡å††", "ç´„15ã€œ20ä¸‡å††", "ç´„20ã€œ24ä¸‡å††"]
]
df_rent = pd.DataFrame(rent_data, columns=["åœ°åŸŸ", "å¯¾è±¡åŒº", "1LDK", "2LDK", "3LDKä»¥ä¸Š"])
st.dataframe(df_rent.style.set_properties(**{"font-size": "12px"}), hide_index=True)

# -------------------------
# è³‡ç”£ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç®—
# -------------------------
years = age_end - age_start
rows = []
saving = 0
investing = 0

for i in range(years + 1):
    age = age_start + i

    # å®¶è³ƒæ±ºå®š
    rent_now = 0
    for s, e, r in rent_settings:
        if s <= age <= e:
            rent_now = r
            break

    # å®¶è³ƒè£œåŠ©ãŒã‚ã‚‹é–“ã¯ç©ç«‹
    if age < support_end_age:
        saving += save * 12
        investing = investing * (1 + rate) + invest * 12
    else:
        total_expense = rent_now * 12
        if total_expense <= saving:
            saving -= total_expense
        else:
            shortfall = total_expense - saving
            saving = 0
            investing = max(0, investing - shortfall)

    total_asset = saving + investing
    rows.append([age, rent_now, round(saving), round(investing), round(total_asset)])

asset_65 = next((row[4] for row in rows if row[0] == 65), 0)

st.markdown(f"### ğŸ’° 65æ­³æ™‚ç‚¹ã®è³‡ç”£é¡ï¼ˆè²¯è“„ï¼‹é‹ç”¨åˆ†ï¼‰ â‡’ **{asset_65:,} ä¸‡å††**")

df_assets = pd.DataFrame(
    rows,
    columns=["å¹´é½¢", "å®¶è³ƒ (ä¸‡å††)", "è²¯è“„ (ä¸‡å††)", "é‹ç”¨ (ä¸‡å††)", "ç·è³‡ç”£ (ä¸‡å††)"]
)

st.dataframe(
    df_assets.style.format({
        "å®¶è³ƒ (ä¸‡å††)": "{:,.0f}",
        "è²¯è“„ (ä¸‡å††)": "{:,.0f}",
        "é‹ç”¨ (ä¸‡å††)": "{:,.0f}",
        "ç·è³‡ç”£ (ä¸‡å††)": "{:,.0f}"
    }).set_properties(subset=["å¹´é½¢"], **{"text-align": "center"}).set_properties(
        subset=["å®¶è³ƒ (ä¸‡å††)", "è²¯è“„ (ä¸‡å††)", "é‹ç”¨ (ä¸‡å††)", "ç·è³‡ç”£ (ä¸‡å††)"], **{"text-align": "right"}
    ),
    height=400
)

# -------------------------
# è€å¾Œç”Ÿæ´»è²»ã®ç›®å®‰
# -------------------------
st.markdown("### ğŸ“Œ è€å¾Œç”Ÿæ´»è²»ã®ç›®å®‰ï¼ˆç”Ÿå‘½ä¿é™ºæ–‡åŒ–ã‚»ãƒ³ã‚¿ãƒ¼ 2024å¹´ï¼‰")
df_living = pd.DataFrame([
    ["é£Ÿè²»", 7.5, ""],
    ["ä½å±…è²»", 2.0, "æŒã¡å®¶æƒ³å®šï¼ˆè³ƒè²¸ã¯ï¼‹3ã€œ7ä¸‡ï¼‰"],
    ["å…‰ç†±ãƒ»æ°´é“", 2.0, ""],
    ["ä¿å¥ãƒ»åŒ»ç™‚", 1.7, ""],
    ["äº¤é€šãƒ»é€šä¿¡", 2.6, ""],
    ["è¶£å‘³ãƒ»å¨¯æ¥½", 2.5, ""],
    ["äº¤éš›è²»", 2.7, ""],
    ["ãã®ä»–", 2.5, "é›‘è²»ãƒ»äºˆå‚™è²»"],
    ["åˆè¨ˆï¼ˆæœ€ä½é™ï¼‰", 23.5, ""],
    ["åˆè¨ˆï¼ˆã‚†ã¨ã‚Šï¼‰", 35.7, "æ—…è¡Œãƒ»è¶£å‘³ãªã©å«ã‚€"]
], columns=["é …ç›®", "æœˆé¡ï¼ˆä¸‡å††ï¼‰", "å‚™è€ƒ"])

st.table(
    df_living.style.format({"æœˆé¡ï¼ˆä¸‡å††ï¼‰": "{:,.1f}ä¸‡å††"})
    .set_properties(subset=["æœˆé¡ï¼ˆä¸‡å††ï¼‰"], **{"text-align": "right"})
)
